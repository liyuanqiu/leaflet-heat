{"version":3,"file":"leaflet-heat-es.cjs.production.min.js","sources":["../src/index.ts"],"sourcesContent":["import {\n  Bounds,\n  point,\n  Browser,\n  Layer,\n  LatLng,\n  ZoomAnimEvent,\n  Map,\n  Util,\n  DomUtil,\n  LayerOptions,\n} from 'leaflet';\n// @ts-ignore\nimport simpleheat from 'simpleheat';\n\ninterface Options {\n  minOpacity: number;\n  maxZoom: number;\n  radius: number;\n  blur: number;\n  max: number;\n  gradient: {\n    [n: number]: string;\n  };\n}\n\nexport type HeatOptions = LayerOptions & Options;\n\nconst HeatLayerClass = Layer.extend({\n  initialize(latlngs: LatLng[], options?: HeatOptions) {\n    this._latlngs = latlngs;\n    Util.setOptions(this, options);\n  },\n\n  setLatLngs(latlngs: LatLng[]) {\n    this._latlngs = latlngs;\n    return this.redraw();\n  },\n\n  addLatLng(latlng: LatLng) {\n    this._latlngs.push(latlng);\n    return this.redraw();\n  },\n\n  setOptions(options: Options) {\n    Util.setOptions(this, options);\n    if (this._heat) {\n      this._updateOptions();\n    }\n    return this.redraw();\n  },\n\n  redraw() {\n    if (this._heat && !this._frame && this._map && !this._map._animating) {\n      this._frame = Util.requestAnimFrame(this._redraw, this);\n    }\n    return this;\n  },\n\n  onAdd(map: Map) {\n    this._map = map;\n\n    if (!this._canvas) {\n      this._initCanvas();\n    }\n\n    if (this.options.pane) {\n      this.getPane().appendChild(this._canvas);\n    } else {\n      map.getPanes().overlayPane.appendChild(this._canvas);\n    }\n\n    map.on('moveend', this._reset, this);\n\n    if (map.options.zoomAnimation && Browser.any3d) {\n      map.on('zoomanim', this._animateZoom, this);\n    }\n\n    this._reset();\n  },\n\n  onRemove(map: Map) {\n    if (this.options.pane) {\n      this.getPane().removeChild(this._canvas);\n    } else {\n      map.getPanes().overlayPane.removeChild(this._canvas);\n    }\n\n    map.off('moveend', this._reset, this);\n\n    if (map.options.zoomAnimation) {\n      map.off('zoomanim', this._animateZoom, this);\n    }\n  },\n\n  addTo(map: Map) {\n    map.addLayer(this);\n    return this;\n  },\n\n  _initCanvas() {\n    this._canvas = DomUtil.create(\n      'canvas',\n      'leaflet-heatmap-layer leaflet-layer'\n    );\n\n    const canvas = this._canvas;\n\n    const originProp = DomUtil.testProp([\n      'transformOrigin',\n      'WebkitTransformOrigin',\n      'msTransformOrigin',\n    ]);\n    if (originProp !== false) {\n      canvas.style[originProp] = '50% 50%';\n    }\n\n    const size = this._map.getSize();\n    canvas.width = size.x;\n    canvas.height = size.y;\n\n    const animated = this._map.options.zoomAnimation && Browser.any3d;\n    DomUtil.addClass(canvas, `leaflet-zoom-${animated ? 'animated' : 'hide'}`);\n\n    this._heat = simpleheat(canvas);\n    this._updateOptions();\n  },\n\n  _updateOptions() {\n    this._heat.radius(\n      this.options.radius || this._heat.defaultRadius,\n      this.options.blur\n    );\n\n    if (this.options.gradient) {\n      this._heat.gradient(this.options.gradient);\n    }\n    if (this.options.max) {\n      this._heat.max(this.options.max);\n    }\n  },\n\n  _reset() {\n    const topLeft = this._map.containerPointToLayerPoint([0, 0]);\n    DomUtil.setPosition(this._canvas, topLeft);\n\n    const size = this._map.getSize();\n\n    if (this._heat._width !== size.x) {\n      this._heat._width = size.x;\n      this._canvas.width = size.x;\n    }\n    if (this._heat._height !== size.y) {\n      this._heat._height = size.y;\n      this._canvas.height = size.y;\n    }\n\n    this._redraw();\n  },\n\n  _redraw() {\n    if (!this._map) {\n      return;\n    }\n    const data = [];\n\n    const r = this._heat._r;\n\n    const size = this._map.getSize();\n\n    const bounds = new Bounds(point([-r, -r]), size.add([r, r]));\n\n    const max = this.options.max === undefined ? 1 : this.options.max;\n\n    const maxZoom =\n      this.options.maxZoom === undefined\n        ? this._map.getMaxZoom()\n        : this.options.maxZoom;\n\n    const v = 1 / 2 ** Math.max(0, Math.min(maxZoom - this._map.getZoom(), 12));\n\n    const cellSize = r / 2;\n\n    const grid: [number, number, number][][] = [];\n\n    const panePos = this._map._getMapPanePos();\n\n    const offsetX = panePos.x % cellSize;\n\n    const offsetY = panePos.y % cellSize;\n\n    let i;\n\n    let len;\n\n    let p;\n\n    let cell;\n\n    let x;\n\n    let y;\n\n    let j;\n\n    let len2;\n\n    let k;\n\n    // console.time('process');\n    for (i = 0, len = this._latlngs.length; i < len; i += 1) {\n      p = this._map.latLngToContainerPoint(this._latlngs[i]);\n      if (bounds.contains(p)) {\n        x = Math.floor((p.x - offsetX) / cellSize) + 2;\n        y = Math.floor((p.y - offsetY) / cellSize) + 2;\n\n        let alt = 1;\n        if (this._latlngs[i].alt !== undefined) {\n          ({ alt } = this._latlngs[i]);\n        } else if (this._latlngs[i][2] !== undefined) {\n          alt = +this._latlngs[i][2];\n        }\n\n        k = alt * v;\n\n        grid[y] = grid[y] || [];\n        cell = grid[y][x];\n\n        if (!cell) {\n          grid[y][x] = [p.x, p.y, k];\n        } else {\n          cell[0] = (cell[0] * cell[2] + p.x * k) / (cell[2] + k); // x\n          cell[1] = (cell[1] * cell[2] + p.y * k) / (cell[2] + k); // y\n          cell[2] += k; // cumulated intensity value\n        }\n      }\n    }\n\n    for (i = 0, len = grid.length; i < len; i += 1) {\n      if (grid[i]) {\n        for (j = 0, len2 = grid[i].length; j < len2; j += 1) {\n          cell = grid[i][j];\n          if (cell) {\n            data.push([\n              Math.round(cell[0]),\n              Math.round(cell[1]),\n              Math.min(cell[2], max),\n            ]);\n          }\n        }\n      }\n    }\n    // console.timeEnd('process');\n\n    // console.time('draw ' + data.length);\n    this._heat.data(data).draw(this.options.minOpacity);\n    // console.timeEnd('draw ' + data.length);\n\n    this._frame = null;\n  },\n\n  _animateZoom(e: ZoomAnimEvent) {\n    const scale = this._map.getZoomScale(e.zoom);\n\n    const offset = this._map\n      ._getCenterOffset(e.center)\n      ._multiplyBy(-scale)\n      .subtract(this._map._getMapPanePos());\n\n    if (DomUtil.setTransform) {\n      DomUtil.setTransform(this._canvas, offset, scale);\n    }\n  },\n});\n\nexport interface HeatLayer extends Layer {\n  setOptions(options: HeatOptions): HeatLayer;\n  addLatLng(latlng: LatLng): HeatLayer;\n  setLatLngs(latlngs: LatLng[]): HeatLayer;\n  redraw(): HeatLayer;\n}\n\nexport function heatLayer(latlngs: LatLng[], options?: HeatOptions): HeatLayer {\n  // @ts-ignore\n  return new HeatLayerClass(latlngs, options);\n}\n"],"names":["HeatLayerClass","Layer","extend","initialize","latlngs","options","_latlngs","Util","setOptions","this","setLatLngs","redraw","addLatLng","latlng","push","_heat","_updateOptions","_frame","_map","_animating","requestAnimFrame","_redraw","onAdd","map","_canvas","_initCanvas","pane","getPane","appendChild","getPanes","overlayPane","on","_reset","zoomAnimation","Browser","any3d","_animateZoom","onRemove","removeChild","off","addTo","addLayer","DomUtil","create","canvas","originProp","testProp","style","size","getSize","width","x","height","y","addClass","simpleheat","radius","defaultRadius","blur","gradient","max","topLeft","containerPointToLayerPoint","setPosition","_width","_height","i","len","p","cell","j","len2","k","data","r","_r","bounds","Bounds","point","add","undefined","maxZoom","getMaxZoom","v","Math","min","getZoom","cellSize","grid","panePos","_getMapPanePos","offsetX","offsetY","length","latLngToContainerPoint","contains","floor","alt","round","draw","minOpacity","e","scale","getZoomScale","zoom","offset","_getCenterOffset","center","_multiplyBy","subtract","setTransform"],"mappings":"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"}