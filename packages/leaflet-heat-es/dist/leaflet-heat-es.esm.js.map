{"version":3,"file":"leaflet-heat-es.esm.js","sources":["../src/index.ts"],"sourcesContent":["import {\n  Bounds,\n  point,\n  Browser,\n  Layer,\n  LatLng,\n  ZoomAnimEvent,\n  Map,\n  Util,\n  DomUtil,\n  LayerOptions,\n} from 'leaflet';\n// @ts-ignore\nimport simpleheat from 'simpleheat';\n\ninterface Options {\n  minOpacity: number;\n  maxZoom: number;\n  radius: number;\n  blur: number;\n  max: number;\n  gradient: {\n    [n: number]: string;\n  };\n}\n\nexport type HeatOptions = LayerOptions & Options;\n\nconst HeatLayerClass = Layer.extend({\n  initialize(latlngs: LatLng[], options?: HeatOptions) {\n    this._latlngs = latlngs;\n    Util.setOptions(this, options);\n  },\n\n  setLatLngs(latlngs: LatLng[]) {\n    this._latlngs = latlngs;\n    return this.redraw();\n  },\n\n  addLatLng(latlng: LatLng) {\n    this._latlngs.push(latlng);\n    return this.redraw();\n  },\n\n  setOptions(options: Options) {\n    Util.setOptions(this, options);\n    if (this._heat) {\n      this._updateOptions();\n    }\n    return this.redraw();\n  },\n\n  redraw() {\n    if (this._heat && !this._frame && this._map && !this._map._animating) {\n      this._frame = Util.requestAnimFrame(this._redraw, this);\n    }\n    return this;\n  },\n\n  onAdd(map: Map) {\n    this._map = map;\n\n    if (!this._canvas) {\n      this._initCanvas();\n    }\n\n    if (this.options.pane) {\n      this.getPane().appendChild(this._canvas);\n    } else {\n      map.getPanes().overlayPane.appendChild(this._canvas);\n    }\n\n    map.on('moveend', this._reset, this);\n\n    if (map.options.zoomAnimation && Browser.any3d) {\n      map.on('zoomanim', this._animateZoom, this);\n    }\n\n    this._reset();\n  },\n\n  onRemove(map: Map) {\n    if (this.options.pane) {\n      this.getPane().removeChild(this._canvas);\n    } else {\n      map.getPanes().overlayPane.removeChild(this._canvas);\n    }\n\n    map.off('moveend', this._reset, this);\n\n    if (map.options.zoomAnimation) {\n      map.off('zoomanim', this._animateZoom, this);\n    }\n  },\n\n  addTo(map: Map) {\n    map.addLayer(this);\n    return this;\n  },\n\n  _initCanvas() {\n    this._canvas = DomUtil.create(\n      'canvas',\n      'leaflet-heatmap-layer leaflet-layer'\n    );\n\n    const canvas = this._canvas;\n\n    const originProp = DomUtil.testProp([\n      'transformOrigin',\n      'WebkitTransformOrigin',\n      'msTransformOrigin',\n    ]);\n    if (originProp !== false) {\n      canvas.style[originProp] = '50% 50%';\n    }\n\n    const size = this._map.getSize();\n    canvas.width = size.x;\n    canvas.height = size.y;\n\n    const animated = this._map.options.zoomAnimation && Browser.any3d;\n    DomUtil.addClass(canvas, `leaflet-zoom-${animated ? 'animated' : 'hide'}`);\n\n    this._heat = simpleheat(canvas);\n    this._updateOptions();\n  },\n\n  _updateOptions() {\n    this._heat.radius(\n      this.options.radius || this._heat.defaultRadius,\n      this.options.blur\n    );\n\n    if (this.options.gradient) {\n      this._heat.gradient(this.options.gradient);\n    }\n    if (this.options.max) {\n      this._heat.max(this.options.max);\n    }\n  },\n\n  _reset() {\n    const topLeft = this._map.containerPointToLayerPoint([0, 0]);\n    DomUtil.setPosition(this._canvas, topLeft);\n\n    const size = this._map.getSize();\n\n    if (this._heat._width !== size.x) {\n      this._heat._width = size.x;\n      this._canvas.width = size.x;\n    }\n    if (this._heat._height !== size.y) {\n      this._heat._height = size.y;\n      this._canvas.height = size.y;\n    }\n\n    this._redraw();\n  },\n\n  _redraw() {\n    if (!this._map) {\n      return;\n    }\n    const data = [];\n\n    const r = this._heat._r;\n\n    const size = this._map.getSize();\n\n    const bounds = new Bounds(point([-r, -r]), size.add([r, r]));\n\n    const max = this.options.max === undefined ? 1 : this.options.max;\n\n    const maxZoom =\n      this.options.maxZoom === undefined\n        ? this._map.getMaxZoom()\n        : this.options.maxZoom;\n\n    const v = 1 / 2 ** Math.max(0, Math.min(maxZoom - this._map.getZoom(), 12));\n\n    const cellSize = r / 2;\n\n    const grid: [number, number, number][][] = [];\n\n    const panePos = this._map._getMapPanePos();\n\n    const offsetX = panePos.x % cellSize;\n\n    const offsetY = panePos.y % cellSize;\n\n    let i;\n\n    let len;\n\n    let p;\n\n    let cell;\n\n    let x;\n\n    let y;\n\n    let j;\n\n    let len2;\n\n    let k;\n\n    // console.time('process');\n    for (i = 0, len = this._latlngs.length; i < len; i += 1) {\n      p = this._map.latLngToContainerPoint(this._latlngs[i]);\n      if (bounds.contains(p)) {\n        x = Math.floor((p.x - offsetX) / cellSize) + 2;\n        y = Math.floor((p.y - offsetY) / cellSize) + 2;\n\n        let alt = 1;\n        if (this._latlngs[i].alt !== undefined) {\n          ({ alt } = this._latlngs[i]);\n        } else if (this._latlngs[i][2] !== undefined) {\n          alt = +this._latlngs[i][2];\n        }\n\n        k = alt * v;\n\n        grid[y] = grid[y] || [];\n        cell = grid[y][x];\n\n        if (!cell) {\n          grid[y][x] = [p.x, p.y, k];\n        } else {\n          cell[0] = (cell[0] * cell[2] + p.x * k) / (cell[2] + k); // x\n          cell[1] = (cell[1] * cell[2] + p.y * k) / (cell[2] + k); // y\n          cell[2] += k; // cumulated intensity value\n        }\n      }\n    }\n\n    for (i = 0, len = grid.length; i < len; i += 1) {\n      if (grid[i]) {\n        for (j = 0, len2 = grid[i].length; j < len2; j += 1) {\n          cell = grid[i][j];\n          if (cell) {\n            data.push([\n              Math.round(cell[0]),\n              Math.round(cell[1]),\n              Math.min(cell[2], max),\n            ]);\n          }\n        }\n      }\n    }\n    // console.timeEnd('process');\n\n    // console.time('draw ' + data.length);\n    this._heat.data(data).draw(this.options.minOpacity);\n    // console.timeEnd('draw ' + data.length);\n\n    this._frame = null;\n  },\n\n  _animateZoom(e: ZoomAnimEvent) {\n    const scale = this._map.getZoomScale(e.zoom);\n\n    const offset = this._map\n      ._getCenterOffset(e.center)\n      ._multiplyBy(-scale)\n      .subtract(this._map._getMapPanePos());\n\n    if (DomUtil.setTransform) {\n      DomUtil.setTransform(this._canvas, offset, scale);\n    }\n  },\n});\n\nexport interface HeatLayer extends Layer {\n  setOptions(options: HeatOptions): HeatLayer;\n  addLatLng(latlng: LatLng): HeatLayer;\n  setLatLngs(latlngs: LatLng[]): HeatLayer;\n  redraw(): HeatLayer;\n}\n\nexport function heatLayer(latlngs: LatLng[], options?: HeatOptions): HeatLayer {\n  // @ts-ignore\n  return new HeatLayerClass(latlngs, options);\n}\n"],"names":["HeatLayerClass","Layer","extend","initialize","latlngs","options","_latlngs","Util","setOptions","setLatLngs","redraw","addLatLng","latlng","push","_heat","_updateOptions","_frame","_map","_animating","requestAnimFrame","_redraw","onAdd","map","_canvas","_initCanvas","pane","getPane","appendChild","getPanes","overlayPane","on","_reset","zoomAnimation","Browser","any3d","_animateZoom","onRemove","removeChild","off","addTo","addLayer","DomUtil","create","canvas","originProp","testProp","style","size","getSize","width","x","height","y","animated","addClass","simpleheat","radius","defaultRadius","blur","gradient","max","topLeft","containerPointToLayerPoint","setPosition","_width","_height","data","r","_r","bounds","Bounds","point","add","undefined","maxZoom","getMaxZoom","v","Math","min","getZoom","cellSize","grid","panePos","_getMapPanePos","offsetX","offsetY","i","len","p","cell","j","len2","k","length","latLngToContainerPoint","contains","floor","alt","round","draw","minOpacity","e","scale","getZoomScale","zoom","offset","_getCenterOffset","center","_multiplyBy","subtract","setTransform","heatLayer"],"mappings":"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"}